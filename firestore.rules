rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Règles pour la collection users
    match /users/{userId} {
      // Lecture: 
      // - Chaque utilisateur peut lire son propre profil
      // - Tout le monde peut lire les profils publics (pour la recherche d'artisans)
      allow read: if 
        request.auth != null && (
          request.auth.uid == userId ||
          resource.data.userType == 'artisan'
        );
      
      // Écriture: uniquement le propriétaire
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Règles pour la collection requests
    match /requests/{requestId} {
      // Lecture: 
      // - Le propriétaire (clientId) peut lire
      // - Les artisans peuvent lire les demandes pending
      allow read: if 
        request.auth != null && (
          // Le client propriétaire peut lire sa demande
          resource.data.clientId == request.auth.uid ||
          // Les artisans peuvent lire les demandes en attente
          (resource.data.status == 'pending')
        );
      
      // Création: 
      // - Seuls les utilisateurs authentifiés peuvent créer
      // - Le clientId doit correspondre à l'UID de l'utilisateur connecté
      allow create: if 
        request.auth != null && 
        request.auth.uid == request.resource.data.clientId &&
        request.resource.data.status == 'pending';
      
      // Mise à jour:
      // - Le client peut annuler sa demande
      // - Les artisans peuvent changer le statut
      allow update: if 
        request.auth != null && (
          // Le client peut annuler sa demande
          (resource.data.clientId == request.auth.uid && 
           request.resource.data.status == 'cancelled' &&
           resource.data.status == 'pending') ||
          // Les artisans peuvent changer le statut
          (resource.data.status == 'pending' && 
           request.resource.data.status in ['accepted', 'in_progress', 'completed'])
        );
      
      // Suppression: uniquement le propriétaire
      allow delete: if 
        request.auth != null && 
        resource.data.clientId == request.auth.uid;
    }
    
    // Règles pour la collection jobs
    match /jobs/{jobId} {
      // Lecture:
      // - L'artisan propriétaire peut lire ses jobs
      // - Le client peut lire les jobs qui lui sont associés
      allow read: if 
        request.auth != null && (
          // L'artisan peut lire ses jobs
          resource.data.artisanId == request.auth.uid ||
          // Le client peut lire les jobs qui le concernent
          resource.data.clientId == request.auth.uid
        );
      
      // Création:
      // - Seuls les artisans authentifiés peuvent créer des jobs
      // - L'artisanId doit correspondre à l'UID de l'utilisateur connecté
      allow create: if 
        request.auth != null && 
        request.auth.uid == request.resource.data.artisanId &&
        request.resource.data.status == 'accepted';
      
      // Mise à jour:
      // - L'artisan peut changer le statut de ses jobs
      allow update: if 
        request.auth != null && 
        resource.data.artisanId == request.auth.uid &&
        request.resource.data.status in ['accepted', 'in_progress', 'completed', 'cancelled'];
      
      // Suppression:
      // - Seul l'artisan propriétaire peut supprimer ses jobs
      allow delete: if 
        request.auth != null && 
        resource.data.artisanId == request.auth.uid;
    }
    
    // Règles pour la collection conversations
    match /conversations/{conversationId} {
      // Lecture: uniquement les participants de la conversation
      allow read: if 
        request.auth != null && 
        request.auth.uid in resource.data.participants;
      
      // Création: uniquement les participants
      allow create: if 
        request.auth != null && 
        request.auth.uid in request.resource.data.participants &&
        request.resource.data.participants.size() == 2;
      
      // Mise à jour: uniquement les participants
      allow update: if 
        request.auth != null && 
        request.auth.uid in resource.data.participants;
      
      // Suppression: uniquement les participants
      allow delete: if 
        request.auth != null && 
        request.auth.uid in resource.data.participants;
    }
    
    // Règles pour la collection messages
    match /messages/{messageId} {
      // Lecture: uniquement l'expéditeur ou le destinataire
      allow read: if 
        request.auth != null && (
          resource.data.senderId == request.auth.uid ||
          resource.data.receiverId == request.auth.uid
        );
      
      // Création: uniquement l'expéditeur
      allow create: if 
        request.auth != null && 
        request.auth.uid == request.resource.data.senderId &&
        request.auth.uid != request.resource.data.receiverId;
      
      // Mise à jour: uniquement pour marquer comme lu (destinataire)
      allow update: if 
        request.auth != null && 
        request.auth.uid == resource.data.receiverId &&
        request.resource.data.keys().hasAll(['isRead']) &&
        request.resource.data.isRead == true;
      
      // Suppression: uniquement l'expéditeur
      allow delete: if 
        request.auth != null && 
        resource.data.senderId == request.auth.uid;
    }
  }
}
