rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Règles pour la collection users
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Règles pour la collection profiles
    match /profiles/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Règles pour la collection requests
    match /requests/{requestId} {
      allow read: if request.auth != null;
      allow create: if 
        request.auth != null && 
        request.auth.uid == request.resource.data.clientId;
      
      allow update, delete: if 
        request.auth != null && 
        resource.data.clientId == request.auth.uid;
    }
    
    // Règles pour la collection jobs
    match /jobs/{jobId} {
      allow read: if request.auth != null;
      allow create: if 
        request.auth != null && 
        request.auth.uid == request.resource.data.artisanId &&
        request.resource.data.status == 'accepted';
      
      allow update: if 
        request.auth != null && 
        resource.data.artisanId == request.auth.uid &&
        request.resource.data.status in ['accepted', 'in_progress', 'completed', 'cancelled'];
      
      allow delete: if 
        request.auth != null && 
        resource.data.artisanId == request.auth.uid;
    }
    
    // Règles pour la collection conversations
    match /conversations/{conversationId} {
      allow read, list: if 
        request.auth != null && 
        request.auth.uid in resource.data.participants;
      
      allow create: if 
        request.auth != null && 
        request.auth.uid in request.resource.data.participants &&
        request.resource.data.participants.size() == 2;
      
      allow update: if 
        request.auth != null && 
        request.auth.uid in resource.data.participants;
      
      allow delete: if 
        request.auth != null && 
        request.auth.uid in resource.data.participants;
    }
    
    // Règles pour la collection messages
    match /conversations/{conversationId}/messages/{messageId} {
      allow read: if 
        request.auth != null && 
        request.auth.uid in resource.data.participants;
      
      allow create: if 
        request.auth != null && 
        request.auth.uid == request.resource.data.senderId &&
        request.auth.uid in request.resource.data.participants;
      
      allow update: if 
        request.auth != null && 
        request.auth.uid == request.data.senderId;
    }
    
    // Règles pour la collection payments
    match /payments/{paymentId} {
      allow read: if 
        request.auth != null && (
          resource.data.clientId == request.auth.uid ||
          resource.data.artisanId == request.auth.uid
        );
      
      allow create: if 
        request.auth != null && (
          request.auth.uid == resource.data.clientId ||
          request.auth.uid == resource.data.artisanId
        );
      
      allow update: if 
        request.auth != null && (
          (request.auth.uid == resource.data.clientId && resource.data.status == 'pending') ||
          (request.auth.uid == resource.data.artisanId && resource.data.status in ['pending', 'processing'])
        );
      
      allow delete: if 
        request.auth != null && 
        request.auth.uid in [resource.data.clientId, resource.data.artisanId];
    }
  }
}
